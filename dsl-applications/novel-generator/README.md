# 长篇小说生成器 - 使用说明

## 📚 应用简介

这是一个专业的长篇小说生成应用，基于 Dify 1.9.2 开发，使用 DeepSeek 模型，支持完整的小说创作流程：

1. **📖 世界观设定** - 构建故事的世界观和背景体系
2. **📋 大纲规划** - 规划完整的故事线和章节结构（30-50章）
3. **👥 角色设定** - 创建立体、鲜活的小说人物
4. **✍️ 章节创作** - 逐章生成高质量小说内容（3000-5000字/章）
5. **✨ 自动优化** - 每章自动审查和润色

## 🚀 快速开始

### 方式1：Web UI 导入（推荐）

1. 登录 Dify 控制台
2. 点击「创建应用」→「导入 DSL」
3. 选择 `novel_generator.yml` 文件
4. 点击「导入」

### 方式2：API 导入

```bash
# 读取 DSL 文件内容
YAML_CONTENT=$(cat novel_generator.yml)

# 调用导入 API
curl -X POST 'http://localhost/console/api/apps/imports' \
  -H 'Authorization: Bearer YOUR_ACCESS_TOKEN' \
  -H 'Content-Type: application/json' \
  -d "{
    \"mode\": \"yaml-content\",
    \"yaml_content\": $(echo "$YAML_CONTENT" | jq -Rs .)
  }"
```

### 方式3：Docker 日志查看（调试用）

```bash
# 查看 API 日志
docker logs dify-api -f --tail 100

# 查看 Worker 日志
docker logs dify-worker -f --tail 100

# 查看所有容器状态
docker ps
```

## ⚙️ 前置配置

### 1. 配置 DeepSeek 模型

在 Dify 控制台中配置 DeepSeek provider：

1. 进入「设置」→「模型供应商」
2. 找到「DeepSeek」
3. 输入您的 API Key
4. 保存配置

如果您想使用其他模型（如 Qwen），需要修改 DSL 文件：

```yaml
# 在 novel_generator.yml 中找到并修改：
model:
  name: deepseek-chat     # 改为: qwen-turbo
  provider: deepseek      # 改为: tongyi
```

### 2. 验证导入结果

导入成功后，检查日志：

```bash
docker logs dify-api --tail 50 | grep -i "import"
```

预期输出应包含 `status: completed` 或 `status: completed-with-warnings`

## 📝 使用流程

### 第1步：启动创作

打开应用后，输入您的小说主题和背景：

```
我想写一部修仙小说，主角是现代都市的普通上班族，
意外获得上古修仙传承，开始在现代社会修炼的故事。
背景设定在2024年的中国一线城市。
```

AI 会自动生成详细的世界观设定，包括：
- 修仙体系（境界、功法）
- 现代社会与修仙界的关系
- 势力分布
- 核心规则

### 第2步：生成大纲

世界观完成后，输入：

```
继续
```

或

```
生成大纲
```

AI 会生成完整的故事大纲，包括：
- 30-50章的章节规划
- 主线情节和冲突
- 伏笔设计
- 高潮设置

### 第3步：创建角色

大纲完成后，输入：

```
继续
```

或

```
创建角色
```

AI 会生成主要角色设定：
- 主角详细资料
- 3-5位重要配角
- 反派角色
- 人物关系网

### 第4步：开始写作

角色设定完成后，输入：

```
生成第1章
```

或

```
写第1章
```

AI 会执行完整的创作流程：
1. 前情提要（第1章跳过）
2. 生成3000-5000字的章节初稿
3. 自动审查（逻辑、角色、情节）
4. 自动润色（文笔、细节、节奏）
5. 输出最终章节

### 第5步：继续创作

每章完成后，可以：

```
继续            # 生成下一章
生成第5章       # 跳到指定章节
重写            # 重新生成当前章节
修改XXX        # 针对性修改
```

## 🎨 核心特性

### 1. 智能流程管理

应用会自动判断当前创作阶段，无需手动切换。基于会话记忆（保留最近10轮对话），AI 能够：
- 记住世界观、大纲、角色设定
- 追踪已生成的章节
- 保持前后文一致性

### 2. 高质量内容生成

**章节创作**包含四个步骤：
- **前情提要**：总结前文关键情节
- **初稿生成**：3000-5000字，严格遵循大纲
- **自动审查**：检查逻辑、角色、情节
- **自动润色**：优化文笔、细节、情感

**创作要求**：
- 语言生动，富有画面感
- 对话自然，符合角色性格
- 场景描写细腻，调动多种感官
- 心理描写深入
- 节奏把控得当

### 3. 灵活的指令支持

支持多种用户指令：
- `继续` / `生成下一章` - 按顺序创作
- `生成第X章` / `写第X章` - 跳到指定章节
- `重写` / `重新生成` - 重做当前内容
- `修改XXX` - 针对性修改

## 🔧 高级配置

### 调整模型参数

在 DSL 文件中修改 temperature 参数：

```yaml
model:
  completion_params:
    temperature: 0.85  # 0-1之间，越高越有创意
```

推荐值：
- 0.7-0.8：更符合逻辑，适合现实题材
- 0.85-0.9：更有创意，适合奇幻科幻
- 0.9-1.0：最具创造性，可能偶尔离谱

### 修改会话记忆长度

```yaml
memory:
  window:
    enabled: true
    size: 10  # 保留最近N轮对话，建议5-15
```

### 自定义开场白

在 DSL 文件中修改：

```yaml
features:
  opening_statement: "您的自定义开场白..."
  suggested_questions:
  - "自定义建议问题1"
  - "自定义建议问题2"
```

## 🐛 常见问题

### 1. 导入失败

**症状**：提示 "Import failed" 或格式错误

**解决方案**：
```bash
# 验证 YAML 格式
python3 -c "import yaml; yaml.safe_load(open('novel_generator.yml'))"

# 查看详细错误
docker logs dify-api --tail 50 | grep -i error
```

### 2. 模型未配置

**症状**：提示 "Model not found" 或 "Provider not configured"

**解决方案**：
1. 进入 Dify 控制台 → 设置 → 模型供应商
2. 配置 DeepSeek 的 API Key
3. 测试模型是否可用

### 3. 生成内容不符合预期

**优化建议**：
- 在初始输入时提供更详细的背景和要求
- 使用 `修改XXX` 指令进行针对性调整
- 调整 temperature 参数
- 增加会话记忆长度

### 4. 章节内容太短

**原因**：模型输出限制

**解决方案**：
- 在提示词中强调字数要求
- 分段生成：`生成第X章上半部分` → `继续写下半部分`
- 使用输出长度更大的模型

### 5. 前后不一致

**解决方案**：
- 确保会话记忆已启用
- 不要在创作过程中清空对话
- 定期手动回顾前文并提醒 AI

## 📊 技术规格

| 项目 | 说明 |
|------|------|
| Dify 版本 | 1.9.2 |
| DSL 版本 | 0.4.0 |
| 应用模式 | advanced-chat |
| 默认模型 | deepseek-chat |
| 节点数量 | 3（Start → LLM → Answer）|
| 会话变量 | 7个（stage, theme, worldview, outline, characters, current_chapter, chapters_summary）|
| 会话记忆 | 10轮（可调整）|
| 章节字数 | 3000-5000字 |

## 🎯 最佳实践

### 1. 初始输入要详细

❌ 不好的输入：
```
写个修仙小说
```

✅ 好的输入：
```
我想写一部现代修仙小说，主角是25岁的程序员李明，
在加班时意外触发了笔记本电脑里的上古修仙传承。
设定在2024年的深圳，修仙界和现代社会有隐秘联系，
主角要在保持正常生活的同时进行修炼，
核心冲突是现代科技与古老修仙之间的碰撞。
```

### 2. 及时确认和调整

每个阶段完成后，仔细阅读内容：
- 世界观是否合理？
- 大纲节奏是否合适？
- 角色设定是否吸引人？

如不满意，立即提出修改：
```
角色设定中主角性格太完美了，给他增加一些缺陷和弱点
```

### 3. 保持创作连贯性

- 不要中途切换话题
- 不要清空对话历史
- 定期保存生成的内容到外部文档

### 4. 充分利用审查润色

AI 会自动审查和润色，但您也可以要求额外优化：
```
这章的打斗场面不够精彩，重点润色动作描写
```

### 5. 分批导出内容

建议每5-10章导出一次内容，避免丢失。

## 📖 示例对话

```
用户：我想写一部赛博朋克小说，背景是2077年的东京...

AI：[生成世界观]
✅ 世界观已完成！输入'继续'生成故事大纲。

用户：继续

AI：[生成大纲]
✅ 大纲已完成！输入'继续'创建角色设定。

用户：继续

AI：[生成角色]
✅ 角色设定完成！输入'生成第1章'开始创作。

用户：生成第1章

AI：[前情提要跳过] → [初稿] → [审查] → [润色]

第一章：霓虹之下的觉醒

2077年的东京，夜幕降临时分...
[3500字精彩内容]

✅ 第1章已完成！输入'继续'生成第2章。
```

## 🔄 更新和维护

### 导出当前配置

```bash
# 从 Dify 导出 DSL
# 方法：应用设置 → 导出 → 下载 YML 文件
```

### 备份重要内容

建议将每次生成的内容保存到：
- 本地文档（Word/Markdown）
- 云端存储（Google Docs/Notion）
- 版本控制（Git）

## 💡 提示

1. **耐心创作**：每章生成需要1-3分钟（包含审查和润色）
2. **保存进度**：Dify 的会话记忆有限，建议外部保存
3. **成本控制**：每章约消耗 10k-20k tokens
4. **质量优先**：不要急于推进，确保每个环节都满意
5. **灵活调整**：随时可以回溯修改前面的内容

## 📞 支持

如遇到问题：
1. 查看 Docker 日志：`docker logs dify-api -f`
2. 检查模型配置：Dify 控制台 → 模型供应商
3. 验证 DSL 格式：`python3 -c "import yaml; yaml.safe_load(open('novel_generator.yml'))"`

---

**祝您创作愉快！期待您的小说佳作！** 📖✨

